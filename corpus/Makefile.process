# -*-makefile-*-
#
# Makefile targets for processing corpus data
#
# - create essential makefiles
# - pre-process data
# - sentence alignment
# - word alignment
#

ifndef LANGUAGE
	LANGUAGE=$(firstword ${LANGUAGES})
endif

SRCDIR   = src/${LANGUAGE}
RAWFILES = $(patsubst src/%.${TXTEXT},raw/%.${XMLEXT}, \
		$(shell find ${SRCDIR} -name '*.${TXTEXT}'))

## make the corpus (all steps)
.PHONY: corpus
corpus:
	${MAKE} preprocess
	${MAKE} annotate
	${MAKE} align
	${MAKE} udparse
	${MAKE} wordalign

## publish the corpus (create website and download packages)
.PHONY: publish
publish: packages webpage cwb-index


## prepare makefiles
.PHONY: prepare
prepare: xml/Makefile wordalign/Makefile

## pre-process data (all languages)
.PHONY: preprocess
preprocess:
	for l in ${LANGUAGES}; do \
		${MAKE} LANGUAGE=$$l preprocess_files; \
	done

## sentence alignment (all language pairs)
.PHONY: align sentalign
align sentalign: xml/Makefile
	${MAKE} -C xml all

## word alignment (all language pairs)
.PHONY: wordalign
wordalign: wordalign/Makefile
	${MAKE} -C wordalign all

## insert word alignments into mySQL database
.PHONY: lexicon
lexicon: lexicon/Makefile
	${MAKE} -C lexicon all



xml/Makefile:
	mkdir -p ${dir $@}
	echo "# -*-makefile-*-" > $@
	echo "include ../Makefile.def" >> $@
	echo "all: align-all" >> $@
	echo "include ../../Makefile.def" >> $@
	echo "include ../../Makefile.align" >> $@

wordalign/Makefile:
	mkdir -p ${dir $@}
	echo "# -*-makefile-*-" > $@
	echo "include ../Makefile.def" >> $@
	echo "all: wordalign-all" >> $@
	echo "include ../../Makefile.def" >> $@
	echo "include ../../Makefile.wordalign" >> $@

lexicon/Makefile:
	mkdir -p ${dir $@}
	echo "# -*-makefile-*-" > $@
	echo "include ../Makefile.def" >> $@
	echo "all: lexicon-all" >> $@
	echo "include ../../Makefile.def" >> $@
	echo "include ../../Makefile.lexicon" >> $@



.PHONY: preprocess_files
preprocess_files: ${RAWFILES}

raw/${LANGUAGE}/%.${XMLEXT}: src/${LANGUAGE}/%.${TXTEXT}
	mkdir -p $(shell dirname $@)
	${PRE} -in $< -out $@

.PHONY: clean-raw
clean-raw:
	for l in ${LANGUAGES}; do \
	    if [ -d "raw/$$l" ]; then \
		rm -fr raw/$$l; \
	    fi \
	done

